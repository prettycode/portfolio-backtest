<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Portfolio Management</title>
    </head>

    <body>
        <h3>Pie: <span id="portfolioName"></span></h3>
        <ul>
            <li>
                <label>
                    NTSX:
                    <input type="range" id="ntsxSlider" min="0" max="100" value="50" />
                    <span id="ntsxValue">50%</span>
                </label>
            </li>
            <li>
                <label>
                    GDE:
                    <input type="range" id="gdeSlider" min="0" max="100" value="50" />
                    <span id="gdeValue">50%</span>
                </label>
            </li>
        </ul>

        <h3>Slices Aggregated</h3>
        <ul id="aggregateDisplay"></ul>

        <h3>Leverage</h3>
        <span id="portfolioLeverage">1.0</span>

        <h3>Pie Composition:</h3>
        <ul id="compositionDisplay"></ul>

        <script>
            const portfolios = {
                ntsx: {
                    id: 'ntsx',
                    name: 'NTSX',
                    percentage: 100,
                    holding: [
                        { name: 'VFINX', percentage: 90 },
                        { name: 'VFITX', percentage: 60 },
                        { name: 'CASHX', percentage: -50 }
                    ]
                },
                gde: {
                    id: 'gde',
                    name: 'GDE',
                    percentage: 100,
                    holding: [
                        { name: 'VFINX', percentage: 90 },
                        { name: '^GOLD', percentage: 90 },
                        { name: 'CASHX', percentage: -80 }
                    ]
                }
            };

            const portfolioData = [
                {
                    id: 'adsfsdf',
                    name: 'NTSX + GDE',
                    percentage: 100,
                    holding: [
                        {
                            ...portfolios.ntsx,
                            percentage: 50
                        },
                        {
                            ...portfolios.gde,
                            percentage: 50
                        }
                    ]
                }
            ];

            const generateAggregatePortfolio = (portfolio) => {
                return portfolio.reduce((acc, parentHolding) => {
                    parentHolding.holding.forEach((holding) => {
                        holding.holding.forEach((item) => {
                            const existing = acc.find((e) => e.name === item.name);
                            if (existing) {
                                existing.percentage += item.percentage * (holding.percentage / 100) * (parentHolding.percentage / 100);
                            } else {
                                acc.push({
                                    name: item.name,
                                    percentage: item.percentage * (holding.percentage / 100) * (parentHolding.percentage / 100)
                                });
                            }
                        });
                    });
                    return acc;
                }, []);
            };

            const calculateAdjustedComposition = (aggregateList, ignoredAssets = ['CASHX']) => {
                const filteredList = aggregateList.filter((holding) => !ignoredAssets.includes(holding.name));
                const total = filteredList.reduce((sum, holding) => sum + holding.percentage, 0);
                return filteredList.map((holding) => ({
                    name: holding.name,
                    adjustedPercentage: (holding.percentage / total) * 100
                }));
            };

            const calculateLeverage = (aggregateList, ignoredAssets = ['CASHX']) =>
                aggregateList
                    .filter((holding) => !ignoredAssets.includes(holding.name))
                    .reduce((sum, holding) => sum + holding.percentage, 0) / 100;

            const updateDisplayData = () => {
                let mainPortfolio = portfolioData[0];

                document.getElementById('portfolioName').textContent = mainPortfolio.name;

                mainPortfolio.holding.find((h) => h.id === 'ntsx').percentage = parseFloat(document.getElementById('ntsxSlider').value);
                mainPortfolio.holding.find((h) => h.id === 'gde').percentage = parseFloat(document.getElementById('gdeSlider').value);

                const aggregate = generateAggregatePortfolio(portfolioData);
                displayAggregatePortfolio(aggregate);
                displayAdjustedComposition(aggregate);
                displayLeverage(aggregate);
            };

            const displayAggregatePortfolio = (aggregateList) =>
                (document.getElementById('aggregateDisplay').innerHTML = aggregateList
                    .map((holding) => `<li>${holding.name}: ${holding.percentage.toFixed(1)}%</li>`)
                    .join(''));

            const displayAdjustedComposition = (aggregateList) =>
                (document.getElementById('compositionDisplay').innerHTML = calculateAdjustedComposition(aggregateList)
                    .map((holding) => `<li>${holding.name}: ${holding.adjustedPercentage.toFixed(1)}%</li>`)
                    .join(''));

            const displayLeverage = (aggregateList) =>
                (document.getElementById('portfolioLeverage').textContent = calculateLeverage(aggregateList).toFixed(2));

            const updateSliderDisplay = () => {
                document.getElementById('ntsxValue').textContent = `${document.getElementById('ntsxSlider').value}%`;
                document.getElementById('gdeValue').textContent = `${document.getElementById('gdeSlider').value}%`;
            };

            document.getElementById('ntsxSlider').addEventListener('input', function () {
                document.getElementById('gdeSlider').value = 100 - this.value;
                updateSliderDisplay();
                updateDisplayData();
            });

            document.getElementById('gdeSlider').addEventListener('input', function () {
                document.getElementById('ntsxSlider').value = 100 - this.value;
                updateSliderDisplay();
                updateDisplayData();
            });

            updateDisplayData();
        </script>
    </body>
</html>
